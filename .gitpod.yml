# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/introduction/learn-gitpod/gitpod-yaml)
# and commit this file to your remote git repository to share the goodness with others.

# Learn more from ready-to-use templates: https://www.gitpod.io/docs/introduction/getting-started/quickstart

image:
  file: .gitpod.Dockerfile

tasks:
  - name: Dependencies & Database
    # This is what I had before but connection pooling doesn't work locally.
    # Keeping this here for now in case I need to reference it later and setup
    # connection pooling once supabase supports it locally.
    # https://github.com/supabase/cli/issues/316
    # init: |
    #   (
    #     set -e
    #     npm install
    #     npm run supabase:start
    #     supabase status -o env | sed 's/^/SUPABASE_/' > .env
    #     SUPABASE_DB_URL="$(supabase status -o env | sed -n 's/^DB_URL=//p' | tr -d '"')"
    #     SUPABASE_POOLING_URL=$(echo "$SUPABASE_DB_URL" | sed "s/:54322/:6543/g")"?pgbouncer=true"
    #     printf "SUPABASE_POOLING_URL=\"$SUPABASE_POOLING_URL\"\n" >> .env
    #     gp sync-done setup
    #   )

    init: |
      (
        set -e
        npm install 
        npm run supabase:start
        supabase status -o env | sed 's/^/SUPABASE_/' > .env
        SUPABASE_DB_URL="$(supabase status -o env | sed -n 's/^DB_URL=//p' | tr -d '"')"
        printf "SUPABASE_POOLING_URL=\"$SUPABASE_DB_URL\"\n" >> .env
        gp sync-done setup
      )
    env:
      SUPABASE_ACCESS_TOKEN: $SUPABASE_TOKEN_PERSONAL # Update this to the name of the token you created in the gitpod user settings.
    command: supabase status

  - name: Webserver
    init: gp sync-await setup
    command: npm run dev

  - name: Prisma
    init: gp sync-await setup
    command: supabase status && npm run prisma:seed && npm run prisma:studio

# List the ports to expose. Learn more: https://www.gitpod.io/docs/configure/workspaces/ports
ports:
  - name: Frontend
    description: Port 3000 for the frontend
    port: 3000
    onOpen: open-browser
  - name: Prisma Studio
    description: Open Prisma Studio
    port: 5555
    onOpen: open-browser

vscode:
  extensions:
    - stkb.rewrap
    - SimonSiefke.svg-preview
    - wayou.vscode-todo-highlight
    - vscode-icons-team.vscode-icons
    - chunsen.bracket-select
    - wmaurer.change-case
    - streetsidesoftware.code-spell-checker
    - IronGeek.vscode-env
    - dbaeumer.vscode-eslint
    - GitHub.copilot
    - GitHub.vscode-pull-request-github
    - eamodio.gitlens
    - kumar-harsh.graphql-for-vscode
    - esbenp.prettier-vscode
    - yoavbls.pretty-ts-errors
    - Prisma.prisma
    - jock.svg
    - bradlc.vscode-tailwindcss
